#!/bin/bash

declare -i offset
declare -i duration

if [ $# -eq 0 ]; then
    (( offset = 90 ))
else
    (( offset = "$1" ))
fi

# Client A (delay: 0 * offset, duration: 7 * offset)
(( duration = 7 * offset ))
gnome-terminal --title=A --geometry 36x25 -x ./client $duration AAA 2>/dev/null

sleep $offset

# Client B (delay: 1 * offset, duration: 4 * offset)
(( duration = 4 * offset ))
gnome-terminal --title=B --geometry 36x25 -x ./client $duration BBB 2>/dev/null

sleep $offset

date
echo "A, B"
ps ax | grep "client " | egrep -v '(dhclient|grep)'
as-describe-auto-scaling-instances --region eu-west-1

# Client C (delay: 2 * offset, duration: 4 * offset)
(( duration = 4 * offset ))
gnome-terminal --title=C --geometry 36x25 -x ./client $duration CCC 2>/dev/null

sleep $offset

date
echo "A, B, C"
ps ax | grep "client " | egrep -v '(dhclient|grep)'
as-describe-auto-scaling-instances --region eu-west-1

# Client D (delay: 3 * offset, duration: 1 * offset)
(( duration = 1 * offset ))
gnome-terminal --title=D --geometry 36x25 -x ./client $duration DDD 2>/dev/null

sleep $offset

date
echo "A, B, C, D"
ps ax | grep "client " | egrep -v '(dhclient|grep)'
as-describe-auto-scaling-instances --region eu-west-1


while ((1)); do
    sleep 10
    date
    ps ax | grep "client " | egrep -v '(dhclient|grep)'
    as-describe-auto-scaling-instances --region eu-west-1

    # Are we done? All clients terminated?
    numclients=`ps ax | grep "client " | egrep -v '(dhclient|grep)' | wc -l`
    if (( numclients == 0 )); then
        break
    fi
done
